# 带外数据

## TCP带外数据

TCP并没有真正的带外数据，而是提供了**紧急模式**(urgent mode)。

### 带外数据示例

#### 带外数据的发送

给定如图的TCP套接字发送缓冲区状态，发送端TCP将为待发送的下一个segment在TCP首部中设置$URG$标志，并把**紧急偏移**(urgent offset)字段设置为指向带外数据之后的字节。

需要注意的是__该segment可能包含也可能不包含我们标记为$OOB$的那个字节__。OOB字节是否发送有几个因素:

* 该套接字发送缓冲区中先于它的字节数
* TCP准备发送给对端segment的大小
* 对端通告的当前窗口。

在TCP层次上，**紧急指针**和**紧急偏移**是不同的：

1. TCP首部16位值称为紧急偏移，它必须加上同一个首部中的序列号字段才能获得32位的紧急指针
2. 只有在同一个首部中URG标志位已经设置的前提下，TCP才会检查紧急偏移。

注意，TCP紧急模式的一个重要特点：TCP首部指出发送端已经进入了紧急模式(即伴随紧急偏移的URG标志已经设置了)，但是由于紧急指针所指的实际数据字节却不一定随同送出。
事实上，即使发送端TCP由于流量控制而暂停发送数据(接收端的套接字接收缓冲区已满，导致其TCP向发送端TCP通告了一个值为0的窗口)，紧急通知照样不伴随任何数据地发送。这也是应用进程使用TCP紧急模式(即带外数据)的一个原因：**即便数据的流动会因为TCP的流量控制而停止，紧急通知却总是无障碍地发送到对端**。

如果我们以`MSG_OOB`标志发送多个字节的带外数据：

``` C
send(sockfd, "abc", 3, MSG_OOB);
```

那么这里最后一个字节(即字母c)被认为是带外字节，TCP的紧急指针指向最后那个字节紧后的位置。

#### 带外数据的接收

从接收端的角度考察带外数据：

1. 当收到一个设置了`URG`标志的segment时，接收端TCP检查紧急指针，确定它是否指向带外数据，也就是判断本segment是不是首个到达的引用从发送端到接收端的数据流中特定字节的紧急模式segment。发送端TCP往往发送多个含有URG标志且紧急指针指向同一个数据字节的segment(通常是在一小段时间内)。这些segment中只有第一个到达的会导致通知接收进程有新的带外数据到达。
2. 当有新的紧急指针到达时，接收进程先被通知到。首先，内核给接收套接字的**属主进程**发送`SIGURG`信号。
    * (前提是接收进程曾调用`fcntl`或者`ioctl`为这个套接字设置了属主进程)，而且该属主进程已为这个套接字建立了信号处理函数。
    * 如果接收进程阻塞在`select`调用中以等待这个套接字出现一个异常条件，`select`调用就返回。
3. 每个连接只有一个`OOB`标志，如果新的OOB字节在旧的OOB字节被读取之前就已到达，则旧的OOB字节会被丢弃。
4. 当由紧急指针指向的实际数据字节到达接收端TCP时，该数据字节既可能被拉出带外，也可能被留在带内，即在线(inline)留存。
    * `SO_OOBINLINE`套接字选项默认是禁止的，对于这样的接收端套接字(即没有开启该选项)，该数据字节并不放入套接字接收缓冲区，而是被放入该连接的一个独立的单字节缓冲区。接收进程从这个单字节缓冲区读入数据的唯一方法是指定`MSG_OOB`标志调用`recv`,  `recvfrom`或者`recvmsg`。如果新的OOB字节在旧的OOB字节被读取之前就到达，则旧的OOB字节会被丢弃。
    * 如果接收进程开启了`SO_OOBINLINE`套接字选项，那么由TCP紧急指针指向的实际数据字节将被留在通常的套接字接收缓冲区中。这种情况下，接收进程不能指定`MSG_OOB`标志读入该数据字节。而应该通过检查该连接的**带外标记**(out-of-bind-mark)以获悉何时访问到这个数据字节。

当然在接收过程中也可能发生一些错误：

* 如果接收进程请求读入带外数据(通过指定`MSG_OOB`标志)，但是对端尚未发送任何OOB数据，则该读入操作返回`EINVAL`
* 在接收进程已被告知对端发送了一个带外字节(通过`SIGURG`或者`select`)的前提下，如果接收进程识图读入该字节，但是该字节尚未到达，读入操作将返回`EWOULDBLOCK`。接收进程此时能做的仅仅是从套接字缓冲区读入数据，以便在该缓冲区中腾出空间，继而允许对端TCP发送出那个带外字节。
* 如果接收进程试图多次读入同一个带外字节，读入操作将返回`EINVAL`
* 如果接收进程已经开启了`SO_OOBINLINE`套接字选项，但是后来试图通过制定`MSG_OOB`标志读入带外数据，该读入操作将返回`EINVAL`

### 小结带外数据

## 客户/服务器心搏函数

## 参考链接
