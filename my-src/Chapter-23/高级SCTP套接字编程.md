# 高级SCTP套接字编程

SCTP是一个面向消息的协议，递送给客户的是部分的或者完整的消息。部分消息的递送前提是应用进程选择向对端发送大消息(比如说大于套接字缓冲区的一半大小)。部分消息被递送给应用进程之后，多个部分消息组合成完整消息的过程并不由SCTP负责。在应用进程看来，一个消息既可以由单个输入操作接收，也可以由若干个相继的输入操作接收。

SCTP服务器程序既可以迭代运行，也可以并发运行，这取决于应用程序开发人员选取的套接字样式。SCTP还提供了从一到多套接字抽取某个关联并使其成为一到一套接字的方法。本方法允许构造既可以迭代运行又可以并发运行的服务器程序。

## 自动关闭的一到多式服务器程序

假设我们编写了一个服务器程序，它不保持任何关联状态，而是依赖客户程序来关闭关联。
依赖客户程序关闭关联存在着这样一个缺点：要是客户打开了一个关联后从不发送任何数据，服务器不得不将资源分配给从不使用这些资源的客户。懒惰的客户会无意中造成对于SCTP实现的拒绝服务攻击。为了避免这个问题，SCTP增设了**自动关闭**(autoclosing)特性。

自动关闭允许SCTP端点指定某个关联可以保持空闲的最大秒钟数。关联在任何方向上都没有数据在传送时就认为它是空闲的。如果关联的空闲时间超过它的最大允许时间，该关联就由SCTP实现自动关闭。

``` C
close_time = 120;
setsockopt(sockfd, IPPROTO_SCTP, SCTP_AUTOCLOSE, &close_time, sizeof(close_time));
 ```

## 部分递送

当应用进程要求SCTP传输过大的消息时，SCTP可能采取部分递送措施。这里“过大”意味着SCTP栈认为没有足够的资源专用于这样的消息。接收端SCTP实现开启本API需要考虑以下几点：

* 所接收消息的缓冲区空间耗用量必须满足或者超过某个门槛
* SCTP栈最多只能从该消息开始处顺序递送到某个缺失断片
* 一旦激发，其他消息必须等到当前消息已被完整接收并递送个接收端应用进程之后才能被递送。也就是说过大的消息会阻塞通常情况下可以递送的所有其他消息的递送，包括其他流中的消息。

## 通知

应用进程可以预定7个通知。

## 捆绑地址子集

## 确定对端和本端地址信息

## 给定IP地址找出关联

## 心搏和地址不可达

## 关联剥离

## 定时控制

## 何时改用SCTP代替TCP
